---
import { getRelativeLocaleUrl } from "astro:i18n";
import config from "$config";
import App from "$layouts/App.astro";
import Navigator from "$layouts/header/Navigator.svelte";
import Footer from "$layouts/Footer.astro";
import Tip from "$components/Tip.svelte";
import "$styles/global.css";
import "$styles/markdown.css";
import "medium-zoom/dist/style.css";
import "katex/dist/katex.min.css";

let route = Astro.url.pathname;

const { locale = config.i18n.defaultLocale, title: subtitle, description = config.description, article } = Astro.props;
const title = config.title;
---

<script>
	import zoom from "medium-zoom/dist/pure";
	import Time from "$utils/time";
	import mermaid from "mermaid";

	// Initialize Mermaid
	mermaid.initialize({
		startOnLoad: false,
		theme: "dark",
		themeVariables: {
			darkMode: true,
			background: "#1e1e1e",
			primaryColor: "#bb2528",
			primaryTextColor: "#fff",
			primaryBorderColor: "#7f2123",
			lineColor: "#f8b229",
			secondaryColor: "#e6e6e6",
			tertiaryColor: "#fff"
		}
	});

	// Render Mermaid diagrams
	const renderMermaid = async () => {
		// Wait a bit for DOM to be fully ready after Swup page load
		await new Promise(resolve => setTimeout(resolve, 50));
		try {
			// Check all possible selectors
			const preMermaid = document.querySelectorAll("pre.mermaid");
			const codeMermaid = document.querySelectorAll("code.language-mermaid");
			const anyMermaid = document.querySelectorAll(".mermaid");

			console.log("Mermaid elements found:", {
				"pre.mermaid": preMermaid.length,
				"code.language-mermaid": codeMermaid.length,
				".mermaid": anyMermaid.length
			});

			// Check all code blocks with mermaid in classList (Shiki might use different format)
			const allCodeBlocks = document.querySelectorAll("code[class*='mermaid']");
			console.log("Code blocks with 'mermaid' in class:", allCodeBlocks.length);
			if (allCodeBlocks.length > 0) {
				console.log("First mermaid code block classList:", Array.from(allCodeBlocks[0].classList));
				console.log("First mermaid code block HTML (first 300 chars):", allCodeBlocks[0].outerHTML.substring(0, 300));
			}

			// Also check for plain mermaid class (Shiki might use just 'mermaid')
			const plainMermaid = document.querySelectorAll("code.mermaid");
			console.log("code.mermaid elements:", plainMermaid.length);

			// Debug: list all code block classes
			const allPreCode = document.querySelectorAll("pre > code");
			console.log("Total pre > code elements:", allPreCode.length);
			const uniqueClasses = new Set();
			allPreCode.forEach(code => {
				code.classList.forEach(cls => uniqueClasses.add(cls));
			});
			console.log("All unique code block classes:", Array.from(uniqueClasses));

			if (preMermaid.length > 0) {
				await mermaid.run({
					querySelector: "pre.mermaid"
				});
			} else if (codeMermaid.length > 0) {
				// Fallback: if pre.mermaid not found but code.language-mermaid exists
				console.log("Using fallback: code.language-mermaid");
				for (const code of codeMermaid) {
					const diagram = code.textContent || "";
					const { svg } = await mermaid.render(`mermaid-${Math.random().toString(36).substr(2, 9)}`, diagram);
					const pre = code.parentElement;
					if (pre?.tagName === "PRE") {
						pre.innerHTML = svg;
					}
				}
			} else if (plainMermaid.length > 0) {
				// Fallback for code.mermaid
				console.log("Using fallback 3: code.mermaid");
				for (const code of plainMermaid) {
					const diagram = code.textContent || "";
					const { svg } = await mermaid.render(`mermaid-${Math.random().toString(36).substr(2, 9)}`, diagram);
					const pre = code.parentElement;
					if (pre?.tagName === "PRE") {
						pre.innerHTML = svg;
					}
				}
			} else if (allCodeBlocks.length > 0) {
				// Second fallback: render from code blocks with mermaid in any class
				console.log("Using fallback 2: code blocks with mermaid in class");
				for (const code of allCodeBlocks) {
					const diagram = code.textContent || "";
					const { svg } = await mermaid.render(`mermaid-${Math.random().toString(36).substr(2, 9)}`, diagram);
					const pre = code.parentElement;
					if (pre?.tagName === "PRE") {
						pre.innerHTML = svg;
					}
				}
			}
		} catch (error) {
			console.error("Mermaid rendering error:", error);
		}
	};

	// Set the `title` attribute of all `<time>` elements to localized date-time strings
	const localizeTimes = () => document.querySelectorAll("time").forEach(time => time.dateTime && (time.title = Time.locale(time.dateTime, navigator.language, Time.userTimezone)));

	// Add zoom effect to images within markdown content
	window.zoom = () => zoom(".markdown img:not([data-nozoom])", { background: "#00000044" });

	// Page initialization function
	function initialize() {
		localizeTimes();
		window.zoom();
		renderMermaid();
	}

	// Execute initialization on first load
	initialize();

	// Listen for Swup page load event and re-initialize on page transitions
	document.addEventListener("swup:enable", () => {
		window.swup?.hooks.on("page:load", initialize);
	});

	// Also listen for astro:page-load as fallback
	document.addEventListener("astro:page-load", initialize);

	// Listen for Swup content replaced event (when new page content is loaded)
	document.addEventListener("swup:content:replaced", initialize);
</script>

<App {locale} {title} {subtitle} {description} {article} author={config.author.name}>
	<Tip client:load />
	<div class="flex flex-col mx-auto *:*:px-3 w-[min(100%,1000px)]">
		<div id="body" class="flex flex-col min-h-screen">
			<header class="sticky top-0 flex items-center justify-between pt-3 pb-1 mb-4 bg-background z-4 sm:static sm:mb-12">
				<a href={getRelativeLocaleUrl(locale)} class="text-lg sm:text-2xl font-bold">{title}</a>
				<Navigator {locale} {route} client:load />
			</header>

			<slot />
		</div>

		<Footer {locale} author={config.author} copyright={config.copyright} />
	</div>
</App>
